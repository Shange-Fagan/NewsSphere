<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Optimized Globe Visualization</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Stylesheets and scripts will be included here -->
  <style>
  /* Global Styles */
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  overflow: hidden;
  font-family: 'Monospace', sans-serif;
}

a, button, input, select, iframe {
  pointer-events: auto;
}

/* Info and Credits */
#info,
#credits {
  position: absolute;
  width: 100%;
  text-align: center;
  color: teal;
}

#info {
  bottom: 7vh;
}

#credits {
  bottom: 4.25vh;
}

/* Tickers */
#dayTicker,
#nightTicker {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 50px; /* Adjust based on content */
  border: none;
  margin: 0;
  padding: 0;
  display: block;
  overflow: hidden;
  z-index: 5;
}

/* Marker Labels */
/*.marker-label {
  position: absolute;
  object-fit: contain;
  font-family: 'Space Mono', monospace;
  transition: opacity 0.3s;
  background: transparent;
  width: 142px;
  height: 186px;
  border: 4px solid rgb(0, 107, 63);
  border-radius: 10px;
  z-index: 10;
  margin: 0;
  padding: 0;
  display: none; /* Hidden by default */
}*/
    
 .marker-label * {
  /* Styles here could affect all child elements, including the iframe */
}
  .marker-label {
  position: absolute;
  font-family: 'Space Mono', monospace;
  transition: opacity 0.3s;
  background: transparent;
  /*width: 142px;*/
  /*height: 186px;*/
  /*border: 4px solid rgb(0, 107, 63);*/
  /*border-radius: 10px;*/
  z-index: 10;
  margin: 0;
  padding: 0;
  display: none; /* Hidden by default */
}

.marker-label.active {
  display: block;
}

.marker-label .close-button {
  position: absolute;
  top: 6px;
  left: 10px;
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid lightgray;
  border-radius: 3px;
  color: white;
  font-size: 14px;
  font-weight: bold;
  opacity: 0.25;
  transition: opacity 0.3s;
  cursor: pointer;
  z-index: 11;
}

.marker-label .close-button:hover {
  opacity: 1;
}

.marker-label .content {
  margin: 4px;
  width: calc(100% - 8px); /* Adjust for margins */
  height: calc(100% - 8px);
}

.marker-label iframe {
  all: initial;
  width: 100%;
  height: 100%;
  border: none;
  display: block;
  position: relative;
  /*z-index: 1;*/
}

/* Remove scrollbar from iframes */
iframe::-webkit-scrollbar {
  display: none;
}
</style>
</head>
<body>
  <!-- Info Section -->
  <div id="info">Click the markers to show the label</div>
  <div id="credits">
    Made by
    <a href="https://www.linkedin.com/in/shange-fagan-bba3a3239/" target="_blank" rel="noopener">Shange Fagan</a>
  </div>

  <!-- Marker Labels (Will be dynamically generated) -->
  <div id="labels-container"></div>

  <!-- Tickers -->
  <iframe
    id="dayTicker"
    src="https://rss.app/embed/v1/ticker/ye6DcnVZx4IHEsUK"
    frameborder="0"
    sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-popups-to-escape-sandbox"
  ></iframe>
  <iframe
    id="nightTicker"
    src="https://rss.app/embed/v1/ticker/ye6DcnVZx4IHEsUK"
    frameborder="0"
    style="display: none;"
    sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-popups-to-escape-sandbox"
  ></iframe>
  <!-- Import Map -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.136.0/build/three.module.js",
      "three/examples/jsm/controls/OrbitControls": "https://unpkg.com/three@0.136.0/examples/jsm/controls/OrbitControls.js",
      "three/examples/jsm/renderers/CSS2DRenderer": "https://unpkg.com/three@0.136.0/examples/jsm/renderers/CSS2DRenderer.js",
      "three/examples/jsm/loaders/RGBELoader": "https://unpkg.com/three@0.136.0/examples/jsm/loaders/RGBELoader.js"
    }
  }
  </script>


  <!-- Scripts -->
  <!-- Include Three.js and other dependencies here -->

  <!-- Main JavaScript -->
  <script type="module">
    // JavaScript code will go here
    import * as THREE from "three";
  import { OrbitControls } from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls";
  import {
    CSS2DRenderer,
    CSS2DObject,
  } from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/renderers/CSS2DRenderer.js";
    import { RGBELoader } from 'https://cdn.jsdelivr.net/npm/three@0.136.0/examples/jsm/loaders/RGBELoader.js';
  
  // Scene Setup
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, innerWidth / innerHeight, 1, 2000);
  camera.position.set(20, 0.5, 15).setLength(17);
  
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  document.body.appendChild(renderer.domElement);
  
  // Label Renderer
  const labelRenderer = new CSS2DRenderer();
  labelRenderer.setSize(innerWidth, innerHeight);
  labelRenderer.domElement.style.position = 'absolute';
  labelRenderer.domElement.style.top = '0px';
  document.body.appendChild(labelRenderer.domElement);
  
  // Controls
  const controls = new OrbitControls(camera, labelRenderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.25;
  controls.enableZoom = true;
  controls.minDistance = 15;
  controls.maxDistance = 20;
  controls.autoRotate = true;
  controls.autoRotateSpeed = 0.1;
  
  // Global Uniforms
  const globalUniforms = {
    time: { value: 0 },
  };
  
  // Handle Window Resize
  window.addEventListener('resize', onWindowResize);
  
  function onWindowResize() {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
    labelRenderer.setSize(innerWidth, innerHeight);
  }
    // Track loaded textures
let texturesLoaded = 0;
const totalTextures = 4; // Update this if you have more or fewer textures

function checkTexturesLoaded() {
  texturesLoaded++;
  if (texturesLoaded === totalTextures) {
    animate(); // Start animation after all textures are loaded
  }
}

// Load Textures
const textureLoader = new THREE.TextureLoader();

// Background Texture
textureLoader.load('js/0f2dd307-0d28-4fe9-9ef9-db84277033dd_hdr3.png', function (texture) {
  scene.background = texture;
  scene.environment = texture;
  checkTexturesLoaded();
});

    // Load Textures
  //const textureLoader = new THREE.TextureLoader();
  const dayTexture = textureLoader.load("//unpkg.com/three-globe/example/img/earth-blue-marble.jpg");
  const nightTexture = textureLoader.load("//unpkg.com/three-globe/example/img/earth-night.jpg");
  const bumpMap = textureLoader.load("//unpkg.com/three-globe/example/img/earth-topology.png");
  const specularMap = textureLoader.load("//unpkg.com/three-globe/example/img/earth-water.png");
  
  // Globe Material
  const globeMaterial = new THREE.MeshPhongMaterial({
    map: dayTexture,
    bumpMap: bumpMap,
    bumpScale: 0.35,
    specularMap: specularMap,
    specular: new THREE.Color('grey'),
    shininess: 15,
    
  });
    
  // Globe Geometry
  const globeGeometry = new THREE.SphereGeometry(5, 64, 64);
  const globeMesh = new THREE.Mesh(globeGeometry, globeMaterial);
  scene.add(globeMesh);
  
  // Atmosphere
  const atmosphereMaterial = new THREE.ShaderMaterial({
  vertexShader: `
    varying vec3 vertexNormal;
    void main() {
      vertexNormal = normalize(normalMatrix * normal);
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,
  fragmentShader: `
    varying vec3 vertexNormal;
    void main() {
      float intensity = pow(0.6 - dot(vertexNormal, vec3(0, 0, 1.0)), 2.0);
      gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity;
    }
  `,
  blending: THREE.AdditiveBlending,
  side: THREE.BackSide,
  transparent: true,
});
const atmosphereMesh = new THREE.Mesh(globeGeometry, atmosphereMaterial);
atmosphereMesh.scale.set(1.1, 1.1, 1.1);
scene.add(atmosphereMesh);
    // Ambient Light
  /*const ambientLight = new THREE.AmbientLight(0x808080);
  scene.add(ambientLight);
  
  // Directional Light
  const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
  directionalLight.position.set(-1, -1, -1);
  scene.add(directionalLight);*/
    // Remove existing lights
//scene.remove(ambientLight);
//scene.remove(directionalLight);

// Add new Ambient Light
const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); // Soft white light
scene.add(ambientLight);

// Add a Directional Light
const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
directionalLight.position.set(5, 5, 5); // Position it to shine on the globe
scene.add(directionalLight);
    // Markers Data
  const markersData = [
    {
      //Africa
      id: 1,
      position: [5.1, 1.2, 1.5],
      iframeSrc: "https://rss.app/embed/v1/carousel/dIqCIlIGNRu8C6sq",
      sandbox:"allow-same-origin allow-scripts",
      frameborder:"0",
      loading:"lazy",
      width:"100%",
      height:"100%"
    },
    // ... Add other markers here
    {
      //Europe
      id: 2,
      position: [5.1, 0.7, 1.8],
      iframeSrc: "https://rss.app/embed/v1/carousel/dIqCIlIGNRu8C6sq",
      sandbox:"allow-same-origin allow-scripts",
      frameborder:"0",
      loading:"lazy",
      width:"100%",
      height:"100%"
    },
    {
      //America
      id: 3,
      position: [5.1, 0.9, 0],
      iframeSrc: "https://rss.app/embed/v1/carousel/j4Lz0RvN9tozg8ti",
      sandbox:"allow-same-origin allow-scripts",
      frameborder:"0",
      loading:"lazy",
      width:"100%",
      height:"100%"
    },
    {
      //South America
      id: 4,
      position: [5.1, 1.6, 0.4],
      iframeSrc: "https://rss.app/embed/v1/carousel/egKZAx1vbuN40QJ5",
      sandbox:"allow-same-origin allow-scripts",
      frameborder:"0",
      loading:"lazy",
      width:"100%",
      height:"100%"
    },
    {
      //Middle East
      id: 5,
      position: [5.1, 1, 2.3],
      iframeSrc: "https://rss.app/embed/v1/carousel/QtI2HAU7LB5FfP93",
      sandbox:"allow-same-origin allow-scripts",
      frameborder:"0",
      loading:"lazy",
      width:"100%",
      height:"100%"
    },
    {
      //Asia
      id: 6,
      position: [5.1, 0.9, 3],
      iframeSrc: "https://rss.app/embed/v1/carousel/dwbg7NploOubDAzi",
      sandbox:"allow-same-origin allow-scripts",
      frameborder:"0",
      loading:"lazy",
      width:"100%",
      height:"100%"
    },
    {
      //Japan
      id: 7,
      position: [5.1, 0.9, 4],
      iframeSrc: "https://rss.app/embed/v1/carousel/H7fYbpNYSCQC0Kob",
      sandbox:"allow-same-origin allow-scripts",
      frameborder:"0",
      loading:"lazy",
      width:"100%",
      height:"100%"
    },
    {
      // Jamaica
      id: 8,
      position: [5.1, 1.2, 0.2],
      iframeSrc: "https://rss.app/embed/v1/carousel/t8w4T1GZ8wZ4bHWQ",
      sandbox:"allow-same-origin allow-scripts",
      frameborder:"0",
      loading:"lazy",
      width:"100%",
      height:"100%"
    },
    {
      //UK
      id: 9,
      position: [5.1, 0.6, 1.45],
      iframeSrc: "https://rss.app/embed/v1/carousel/h02Ux8iXmbwRcpWU",
      sandbox:"allow-same-origin allow-scripts",
      frameborder:"0",
      loading:"lazy",
      width:"100%",
      height:"100%"
    },
  ];
  
  // Marker Geometry and Material
  const markerGeometry = new THREE.PlaneGeometry();
  const markerMaterial = new THREE.MeshBasicMaterial({
    color: 0xff3232,
    onBeforeCompile: (shader) => {
      shader.uniforms.time = globalUniforms.time;
      shader.vertexShader = `
      	attribute float phase;
        varying float vPhase;
        ${shader.vertexShader}
      `.replace(
        `#include <begin_vertex>`,
        `#include <begin_vertex>
        	vPhase = phase; // de-synch of ripples
        `
      );
      shader.fragmentShader = `
      	uniform float time;
        varying float vPhase;
      	${shader.fragmentShader}
      `.replace(
        `vec4 diffuseColor = vec4( diffuse, opacity );`,
        `
        vec2 lUv = (vUv - 0.5) * 2.;
        float val = 0.;
        float lenUv = length(lUv);
        val = max(val, 1. - step(0.25, lenUv)); // central circle
        val = max(val, step(0.4, lenUv) - step(0.5, lenUv)); // outer circle

        float tShift = fract(time * 0.5 + vPhase);
        val = max(val, step(0.4 + (tShift * 0.6), lenUv) - step(0.5 + (tShift * 0.5), lenUv)); // ripple

        if (val < 0.5) discard;

        vec4 diffuseColor = vec4( diffuse, opacity );`
      );
    },
  });
  markerMaterial.defines = { USE_UV: '' };
  
  // Creating Markers
  const markerCount = markersData.length;
  const markers = new THREE.InstancedMesh(markerGeometry, markerMaterial, markerCount);
  
  const dummy = new THREE.Object3D();
  const phaseArray = [];
  
  markersData.forEach((data, index) => {
    const [radius, phi, theta] = data.position;
    dummy.position.setFromSphericalCoords(radius, phi, theta);
    dummy.lookAt(dummy.position.clone().setLength(radius + 1));
    dummy.updateMatrix();
    markers.setMatrixAt(index, dummy.matrix);
    phaseArray.push(Math.random());
    data.worldPosition = dummy.position.clone();
  });
  
  markerGeometry.setAttribute('phase', new THREE.InstancedBufferAttribute(new Float32Array(phaseArray), 1));
  scene.add(markers);
    // Labels Container
  const labelsContainer = document.getElementById('labels-container');
  
  // Create Labels
  markersData.forEach((data) => {
    // Create Label Div
    const labelDiv = document.createElement('div');
    labelDiv.className = 'marker-label';
    labelDiv.id = `label-${data.id}`;
  
    // Close Button
    const closeButton = document.createElement('button');
    closeButton.className = 'close-button';
    closeButton.innerText = 'X';
    closeButton.addEventListener('click', () => {
      labelDiv.classList.remove('active');
    });
    labelDiv.appendChild(closeButton);
  
    // Content Div
    const contentDiv = document.createElement('div');
    contentDiv.className = 'content';
    labelDiv.appendChild(contentDiv);
  
    // Append to Labels Container
    labelsContainer.appendChild(labelDiv);
  
    // CSS2DObject
    const labelObject = new CSS2DObject(labelDiv);
    labelObject.position.copy(data.worldPosition);
    scene.add(labelObject);
  
    // Store label object for interaction
    data.labelObject = labelObject;
    labelDiv.addEventListener('mousedown', (event) => {
      event.stopPropagation();
    });
    labelDiv.addEventListener('touchstart', (event) => {
      event.stopPropagation();
  });
  });
    // Raycaster for Interaction
  const raycaster = new THREE.Raycaster();
  const pointer = new THREE.Vector2();
  
  window.addEventListener('pointerdown', (event) => {
    pointer.x = (event.clientX / innerWidth) * 2 - 1;
    pointer.y = -(event.clientY / innerHeight) * 2 + 1;
    raycaster.setFromCamera(pointer, camera);
  
    const intersects = raycaster.intersectObject(markers).filter((m) => {
      return m.uv.subScalar(0.5).length() * 2 < 0.25;
    });
  
    if (intersects.length > 0) {
      const instanceId = intersects[0].instanceId;
      const data = markersData[instanceId];
  
      // Update Label Content
      const labelDiv = document.getElementById(`label-${data.id}`);
      const contentDiv = labelDiv.querySelector('.content');
      contentDiv.innerHTML = `<iframe src="${data.iframeSrc}" frameborder="0"></iframe>`;
  
      // Show Label
      labelDiv.classList.add('active');
    }
  });
    // Animation Loop
  const clock = new THREE.Clock();
  
  function animate() {
    requestAnimationFrame(animate);
  
    // Update time uniform
    globalUniforms.time.value = clock.getElapsedTime();
  
    // Update controls
    controls.update();
  
    // Render
    renderer.render(scene, camera);
    labelRenderer.render(scene, camera);
  }
  
  animate();
  </script>
</body>
</html>
